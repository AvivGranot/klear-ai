// Klear AI Multi-Tenant SaaS Database Schema
// AI-powered internal knowledge assistant for businesses
// Designed by Boris Cherny principles: Type-safe, scalable, isolated

generator client {
  provider = "prisma-client-js"
}

datasource db {
  // Use SQLite for local dev, PostgreSQL for production
  // Set DATABASE_URL in .env appropriately
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ==================== SUBSCRIPTION & BILLING ====================

model Subscription {
  id                 String             @id @default(uuid())
  companyId          String             @unique
  company            Company            @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Plan Details
  plan               String             @default("STARTER") // STARTER, GROWTH, BUSINESS, ENTERPRISE
  status             String             @default("TRIAL")   // TRIAL, ACTIVE, PAST_DUE, CANCELED, PAUSED

  // Limits based on plan
  maxUsers           Int                @default(10)
  maxKnowledgeItems  Int                @default(100)
  maxQueriesPerMonth Int                @default(1000)

  // Current Usage
  currentUsers       Int                @default(0)
  currentKnowledge   Int                @default(0)
  queriesThisMonth   Int                @default(0)
  usageResetAt       DateTime?

  // Stripe Billing
  stripeCustomerId   String?
  stripeSubId        String?
  stripePriceId      String?

  // Trial & Dates
  trialEndsAt        DateTime?
  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?
  canceledAt         DateTime?

  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
}

// ==================== COMPANY (TENANT) ====================

model Company {
  id               String            @id @default(uuid())

  // Identity
  name             String
  slug             String            @unique // URL-safe: "jolika-chocolate"
  industry         String?
  logo             String?

  // Branding
  primaryColor     String            @default("#25D366")
  welcomeMessage   String?
  botName          String            @default("Klear AI")

  // Settings
  timezone         String            @default("Asia/Jerusalem")
  language         String            @default("he")

  // Relations
  subscription     Subscription?
  users            User[]
  knowledgeItems   KnowledgeItem[]
  categories       Category[]
  conversations    Conversation[]
  escalations      Escalation[]
  whatsappSessions WhatsAppSession[]
  whatsappConfig   WhatsAppConfig?
  queryLogs        QueryLog[]

  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  @@index([slug])
}

model WhatsAppConfig {
  id              String   @id @default(uuid())
  companyId       String   @unique
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // WhatsApp Business API
  phoneNumber     String?
  phoneNumberId   String?
  businessId      String?
  accessToken     String?

  // Webhook
  webhookVerifyToken String?

  // Status
  isActive        Boolean  @default(false)
  verifiedAt      DateTime?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// ==================== USERS & AUTH ====================

model User {
  id            String    @id @default(uuid())

  // Authentication
  email         String?   @unique
  phone         String?
  passwordHash  String?

  // Profile
  name          String
  avatarUrl     String?

  // Authorization
  role          String    @default("employee") // employee, manager, admin, owner
  companyId     String
  company       Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Status
  isActive      Boolean   @default(true)
  emailVerified DateTime?
  lastLoginAt   DateTime?
  lastActiveAt  DateTime?

  // Relations
  sessions           Session[]
  conversations      Conversation[]
  corrections        AnswerCorrection[]
  messages           Message[]
  whatsappSessions   WhatsAppSession[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([phone, companyId])
  @@index([companyId, role])
  @@index([email])
}

model Session {
  id           String   @id @default(uuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Token
  token        String   @unique

  // Context
  userAgent    String?
  ipAddress    String?
  deviceType   String?  // web, mobile, whatsapp

  // Validity
  expiresAt    DateTime
  lastUsedAt   DateTime @default(now())
  createdAt    DateTime @default(now())

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
}

model MagicLink {
  id        String   @id @default(uuid())
  email     String
  token     String   @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())

  @@index([token])
  @@index([email])
}

// ==================== KNOWLEDGE BASE ====================

model Category {
  id          String     @id @default(uuid())
  name        String
  nameHe      String?
  description String?
  icon        String?
  color       String?
  order       Int        @default(0)

  companyId   String
  company     Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Hierarchical
  parentId    String?
  parent      Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryHierarchy")

  // Relations
  knowledgeItems KnowledgeItem[]

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@unique([name, companyId])
  @@index([companyId])
}

model KnowledgeItem {
  id          String    @id @default(uuid())

  // Content
  title       String
  titleHe     String?
  content     String
  contentHe   String?

  // Classification
  type        String    @default("faq") // faq, document, procedure, policy, announcement
  categoryId  String?
  category    Category? @relation(fields: [categoryId], references: [id])
  tags        String?   // JSON array of tags

  // AI
  embedding   String?   // JSON array for vector search
  keywords    String?   // Extracted keywords

  // Metadata
  priority    Int       @default(0)
  frequency   Int       @default(0) // How often referenced
  isActive    Boolean   @default(true)
  viewCount   Int       @default(0)

  // Company scope
  companyId   String
  company     Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Relations
  usedInMessages Message[]
  media          MediaItem[]
  escalations    Escalation[]

  // Source tracking
  sourceType  String?   // manual, import, learned
  sourceUrl   String?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([companyId, isActive])
  @@index([companyId, type])
  @@index([categoryId])
}

model MediaItem {
  id              String        @id @default(uuid())
  knowledgeItemId String?
  knowledgeItem   KnowledgeItem? @relation(fields: [knowledgeItemId], references: [id], onDelete: Cascade)
  companyId       String

  filename        String
  originalName    String
  mimeType        String
  size            Int
  url             String
  thumbnailUrl    String?
  duration        Int?          // For video/audio

  createdAt       DateTime      @default(now())

  @@index([knowledgeItemId])
}

// ==================== CONVERSATIONS & MESSAGES ====================

model Conversation {
  id          String   @id @default(uuid())
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // User (nullable for anonymous web chat)
  userId      String?
  user        User?    @relation(fields: [userId], references: [id])

  // Status
  status      String   @default("active") // active, resolved, pending_review, escalated

  // Feedback
  rating      Int?     // 1-5 satisfaction
  feedback    String?

  // Source
  channel     String   @default("web") // web, whatsapp, api

  // Relations
  messages    Message[]

  resolvedAt  DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([companyId, status])
  @@index([userId])
  @@index([createdAt])
}

model Message {
  id              String        @id @default(uuid())
  conversationId  String
  conversation    Conversation  @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  senderId        String?
  sender          User?         @relation(fields: [senderId], references: [id])

  // Content
  content         String
  contentHe       String?
  role            String        // user, assistant, system

  // AI Response Metadata
  knowledgeItemId String?
  knowledgeItem   KnowledgeItem? @relation(fields: [knowledgeItemId], references: [id])
  confidence      Float?
  responseTimeMs  Int?

  // Media
  mediaUrls       String?       // JSON array

  // Editing
  isEdited        Boolean       @default(false)
  editedAt        DateTime?

  // Corrections
  corrections     AnswerCorrection[]

  createdAt       DateTime      @default(now())

  @@index([conversationId])
  @@index([createdAt])
}

model AnswerCorrection {
  id              String   @id @default(uuid())
  messageId       String
  message         Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)

  managerId       String
  manager         User     @relation(fields: [managerId], references: [id])

  originalContent String
  correctedContent String
  reason          String?

  // Learning
  shouldLearn     Boolean  @default(true)
  appliedAt       DateTime?

  createdAt       DateTime @default(now())

  @@index([messageId])
  @@index([managerId])
}

// ==================== WHATSAPP SESSIONS ====================

model WhatsAppSession {
  id             String    @id @default(uuid())
  phoneNumber    String

  companyId      String
  company        Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)

  userId         String?
  user           User?     @relation(fields: [userId], references: [id])

  // Onboarding
  onboardingStep String    @default("intro") // intro, role_select, name_input, complete
  userRole       String?   // employee, manager
  userName       String?

  // Status
  isActive       Boolean   @default(true)
  lastMessageAt  DateTime  @default(now())

  // Relations
  messages               BotMessage[]
  pendingEscalations     Escalation[] @relation("EmployeeEscalations")
  handledEscalations     Escalation[] @relation("ManagerEscalations")

  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@unique([phoneNumber, companyId])
  @@index([companyId, isActive])
  @@index([companyId, userRole])
}

model BotMessage {
  id          String          @id @default(uuid())
  sessionId   String
  session     WhatsAppSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  direction   String          // inbound, outbound
  content     String
  mediaUrls   String?         // JSON array
  messageType String          @default("text")
  waMessageId String?         // WhatsApp message ID

  createdAt   DateTime        @default(now())

  @@index([sessionId])
  @@index([createdAt])
}

// ==================== ESCALATIONS ====================

model Escalation {
  id                   String            @id @default(uuid())
  companyId            String
  company              Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Employee Side
  employeeSessionId    String
  employeeSession      WhatsAppSession   @relation("EmployeeEscalations", fields: [employeeSessionId], references: [id])
  employeeQuery        String
  employeeMessageId    String?

  // Manager Side
  managerSessionId     String?
  managerSession       WhatsAppSession?  @relation("ManagerEscalations", fields: [managerSessionId], references: [id])
  managerResponse      String?
  managerMediaUrls     String?           // JSON array

  // Status
  status               String            @default("pending") // pending, in_progress, resolved, canceled
  priority             Int               @default(0)

  // Learning
  shouldAddToKB        Boolean           @default(true)
  knowledgeItemId      String?
  knowledgeItem        KnowledgeItem?    @relation(fields: [knowledgeItemId], references: [id])

  // Timestamps
  createdAt            DateTime          @default(now())
  assignedAt           DateTime?
  resolvedAt           DateTime?
  updatedAt            DateTime          @updatedAt

  @@index([companyId, status])
  @@index([employeeSessionId])
  @@index([managerSessionId, status])
}

// ==================== ANALYTICS ====================

model QueryLog {
  id            String   @id @default(uuid())
  companyId     String
  company       Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Query
  query         String
  queryEmbedding String? // JSON array

  // Response
  response      String?
  confidence    Float?
  responseTime  Int?     // in milliseconds

  // Feedback
  wasHelpful    Boolean?
  feedbackText  String?

  // Source
  channel       String   @default("web") // web, whatsapp, api
  userId        String?
  sessionId     String?

  createdAt     DateTime @default(now())

  @@index([companyId, createdAt])
  @@index([companyId, wasHelpful])
}
